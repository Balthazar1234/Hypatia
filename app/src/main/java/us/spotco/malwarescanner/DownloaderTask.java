/*
Hypatia: A realtime malware scanner for Android
Copyright (c) 2017-2018 Divested Computing, Inc.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
*/
package us.spotco.malwarescanner;

import android.os.AsyncTask;

import java.io.File;
import java.io.FileOutputStream;
import java.net.HttpURLConnection;

public class DownloaderTask extends AsyncTask<Object, String, String> {

    @Override
    protected String doInBackground(Object... objects) {
        String url = (String) objects[0];
        File out = new File((String) objects[1]);
        publishProgress("Downloading " + url);
        try {
            HttpURLConnection connection = Utils.getConnection(url);
            if (out.exists()) {
                connection.setIfModifiedSince(out.lastModified());
            }
            connection.connect();
            int res = connection.getResponseCode();
            if (res != 304) {
                if (res == 200) {
                    if (out.exists()) {
                        out.delete();
                    }
                    FileOutputStream fileOutputStream = new FileOutputStream(out);

                    final byte data[] = new byte[1024];
                    int count;
                    while ((count = connection.getInputStream().read(data, 0, 1024)) != -1) {
                        fileOutputStream.write(data, 0, count);
                    }

                    fileOutputStream.close();
                    publishProgress("Successfully downloaded\n");
                } else {
                    publishProgress("File not downloaded, response code " + res + "\n");
                }
            } else {
                publishProgress("File not changed\n");
            }
            connection.disconnect();
        } catch (Exception e) {
            e.printStackTrace();
            out.delete();
            publishProgress("Failed to download, check logcat\n");
        }
        return null;
    }

    @Override
    protected final void onProgressUpdate(String... progress) {

    }
}